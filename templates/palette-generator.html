{% extends "base.html" %}

{% block title %}Palette Generator - Swatchy{% endblock %}

{% block extra_css %}
<style>
  /* Custom dropdown styling */
  .custom-select {
    position: relative;
    min-width: 100px;
  }

  .custom-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 16px;
    user-select: none;
    -webkit-user-select: none;
  }

  .custom-select-trigger:active,
  .custom-select.open .custom-select-trigger {
    border-color: #a78bfa;
    box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
  }

  .custom-select-trigger svg {
    width: 12px;
    height: 12px;
    margin-left: 8px;
    flex-shrink: 0;
    transition: transform 0.2s;
  }

  .custom-select.open .custom-select-trigger svg {
    transform: rotate(180deg);
  }

  .custom-select-options {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 100;
    overflow: hidden;
  }

  .custom-select.open .custom-select-options {
    display: block;
  }

  .custom-select-option {
    padding: 10px 14px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .custom-select-option:active,
  .custom-select-option:hover {
    background: #f3f4f6;
  }

  .custom-select-option.selected {
    background: #ede9fe;
    font-weight: 600;
  }

  .color-column {
    min-height: 60px;
    flex: 1;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    position: relative;
    cursor: pointer;
    transition: flex 0.3s;
  }

  @media (min-width: 768px) {
    .color-column {
      min-height: 200px;
      flex-direction: column;
      justify-content: center;
      padding: 20px;
    }
  }

  .color-column:hover .color-actions {
    opacity: 1;
  }

  .locked-indicator {
    position: relative;
    width: 36px;
    height: 36px;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 12px;
  }

  .locked-indicator:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  @media (min-width: 768px) {
    .locked-indicator {
      position: absolute;
      top: -54px;
      left: 50%;
      transform: translateX(-50%);
      width: 44px;
      height: 44px;
      margin-right: 0;
    }
  }

  .locked-indicator svg {
    width: 20px;
    height: 20px;
    opacity: 0.7;
  }

  @media (min-width: 768px) {
    .locked-indicator svg {
      width: 28px;
      height: 28px;
    }
  }

  .locked-indicator .icon-unlocked {
    display: none;
  }

  .locked-indicator:hover .icon-locked {
    display: none;
  }

  .locked-indicator:hover .icon-unlocked {
    display: block;
  }

    .color-actions {
    display: flex;
    gap: 8px;
    opacity: 1;
  }

  @media (min-width: 768px) {
    .color-actions {
      position: absolute;
      bottom: 20px;
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .color-column:hover .color-actions {
      opacity: 1;
    }
  }

  .action-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.25);
    color: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    backdrop-filter: blur(5px);
  }

  .action-btn:hover {
    background: rgba(255,255,255,0.4);
    transform: scale(1.1);
  }

  .action-btn.locked {
    background: rgba(255,255,255,0.5);
  }

  @media (min-width: 768px) {
    .action-btn {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.2);
    }

    .action-btn.locked {
      background: rgba(255,255,255,0.4);
    }
  }

  .color-picker-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 500;
  }

  .color-picker-overlay.visible {
    display: flex;
  }

  .picker-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.15s;
  }

  .picker-item:hover {
    background: #f3f4f6;
  }

  .picker-swatch {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    margin-right: 12px;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #1f2937;
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 1000;
  }

  .toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
</style>
{% endblock %}

{% block content %}
<div class="h-[calc(100vh-140px)] flex flex-col">
  <!-- Header Controls -->
  <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Palette Generator</h1>
        <p class="text-sm text-gray-600">Generate random color palettes with locking support</p>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <!-- Palette Size -->
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">Colors:</label>
          <div class="custom-select" id="paletteSizeSelect" data-value="5">
            <div class="custom-select-trigger">
              <span>5</span>
              <svg viewBox="0 0 12 12" fill="#6b7280"><path d="M6 8L1 3h10z"/></svg>
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option" data-value="3">3</div>
              <div class="custom-select-option" data-value="4">4</div>
              <div class="custom-select-option selected" data-value="5">5</div>
              <div class="custom-select-option" data-value="6">6</div>
            </div>
          </div>
        </div>

        <!-- Line Filter -->
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">Line:</label>
          <div class="custom-select" id="lineFilterSelect" data-value="all">
            <div class="custom-select-trigger">
              <span>All</span>
              <svg viewBox="0 0 12 12" fill="#6b7280"><path d="M6 8L1 3h10z"/></svg>
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option selected" data-value="all">All</div>
              <div class="custom-select-option" data-value="Honolulu">Honolulu</div>
              <div class="custom-select-option" data-value="Oahu">Oahu</div>
              <div class="custom-select-option" data-value="Kaala">Kaala</div>
            </div>
          </div>
        </div>

        <!-- Generate Button -->
        <button id="generateBtn" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Generate
        </button>

        <!-- Copy All Button -->
        <button id="copyAllBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2" title="Copy all color details">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Copy All
        </button>

        <span class="hidden md:inline text-xs text-gray-400">or press Space</span>
      </div>
    </div>

    <!-- Tag Filter Section -->
    <div class="border-t border-gray-100 pt-4">
      <!-- Toggle Header -->
      <button id="tagFilterToggle" class="w-full flex items-center justify-between text-left hover:bg-gray-50 -mx-4 px-4 py-2 rounded-lg transition-colors">
        <div class="flex items-center gap-2">
          <h3 class="text-sm font-semibold text-gray-700">Filter by Tags</h3>
          <span id="tagFilterIndicator" class="hidden w-2 h-2 bg-primary-600 rounded-full"></span>
        </div>
        <div class="flex items-center gap-2">
          <span id="tagMatchCount" class="text-xs text-gray-500"></span>
          <svg id="tagFilterChevron" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
      </button>

      <!-- Expandable Content -->
      <div id="tagFilterContent" class="hidden">
        <div class="flex items-center justify-between mb-3 mt-3">
          <button id="clearTagFilters" class="text-xs text-primary-600 hover:text-primary-700 font-medium hidden">Clear All Filters</button>
        </div>

        <!-- Preset Buttons -->
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-orange-100 to-pink-100 text-orange-700 hover:from-orange-200 hover:to-pink-200 transition-all border border-orange-200" data-preset="warm-pastels">
            Warm Pastels
          </button>
          <button class="preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-blue-100 to-cyan-100 text-blue-700 hover:from-blue-200 hover:to-cyan-200 transition-all border border-blue-200" data-preset="cool-vibrant">
            Cool Vibrant
          </button>
          <button class="preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-amber-100 to-stone-100 text-amber-700 hover:from-amber-200 hover:to-stone-200 transition-all border border-amber-200" data-preset="earth-tones">
            Earth Tones
          </button>
          <button class="preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-rose-100 to-orange-100 text-rose-700 hover:from-rose-200 hover:to-orange-200 transition-all border border-rose-200" data-preset="portrait">
            Portrait Set
          </button>
          <button class="preset-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 hover:from-purple-200 hover:to-pink-200 transition-all border border-purple-200" data-preset="harmony">
            Harmonious
          </button>
        </div>

        <!-- Tag Categories -->
        <div class="flex flex-wrap gap-2" id="tagFilters">
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="warm">warm</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="cool">cool</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="light">light</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="dark">dark</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="muted">muted</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="vibrant">vibrant</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="pastel">pastel</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="skin-tone">skin-tone</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all" data-tag="earth-tone">earth-tone</button>
          <button class="tag-chip px-2.5 py-1 rounded-full text-xs font-medium bg-gray-600 text-white hover:bg-gray-700 transition-all" data-tag="clear">Clear All</button>
        </div>
      </div>

      <!-- Active Filters Display (always visible when filters are active) -->
      <div id="activeTagFilters" class="hidden mt-3 flex items-center gap-2 flex-wrap">
        <span class="text-xs text-gray-500">Active:</span>
        <div id="activeTagChips" class="flex items-center gap-1 flex-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Palette Display -->
  <div class="flex-1 bg-white rounded-2xl shadow-lg overflow-auto flex flex-col md:flex-row" id="paletteContainer">
    <!-- Color columns will be rendered here -->
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">Copied!</div>

<!-- Color Picker Modal -->
<div class="color-picker-overlay" id="colorPickerOverlay">
  <div class="bg-white rounded-2xl w-full max-w-md mx-4 max-h-[80vh] flex flex-col shadow-2xl">
    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
      <h3 class="font-bold text-gray-800">Select Color</h3>
      <button id="closePicker" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="p-4 border-b border-gray-100">
      <div class="relative">
        <input type="text" id="pickerSearch" placeholder="Search by name or code..."
               class="w-full px-4 py-2 pl-10 rounded-lg border border-gray-200 focus:border-primary-400 focus:ring-2 focus:ring-primary-100 outline-none">
        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-2" id="pickerList">
      <!-- Colors will be rendered here -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // State
  let currentPalette = [];
  let lockedIndices = new Set();

  // Custom select helper
  function getSelectValue(id) {
    return document.getElementById(id).dataset.value;
  }

  function setSelectValue(id, value) {
    const el = document.getElementById(id);
    el.dataset.value = value;
    const label = el.querySelector('.custom-select-option[data-value="' + value + '"]');
    el.querySelector('.custom-select-trigger span').textContent = label ? label.textContent : value;
    el.querySelectorAll('.custom-select-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.value === value);
    });
  }

  function initCustomSelects() {
    document.querySelectorAll('.custom-select').forEach(select => {
      const trigger = select.querySelector('.custom-select-trigger');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close any other open selects
        document.querySelectorAll('.custom-select.open').forEach(s => {
          if (s !== select) s.classList.remove('open');
        });
        select.classList.toggle('open');
      });

      select.querySelectorAll('.custom-select-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.dataset.value;
          setSelectValue(select.id, value);
          select.classList.remove('open');
          generatePalette();
        });
      });
    });

    // Close selects when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
    });
  }

  // Load color data and init
  document.addEventListener('DOMContentLoaded', async () => {
    await loadColorData();
    initCustomSelects();
    initTagFiltering();

    // Check for colors in URL
    const urlParams = new URLSearchParams(window.location.search);
    const colorsParam = urlParams.get('colors');
    if (colorsParam) {
      loadColorsFromUrl(colorsParam);
    } else {
      generatePalette();
    }

    // Event listeners
    document.getElementById('generateBtn').addEventListener('click', generatePalette);
    document.getElementById('copyAllBtn').addEventListener('click', copyAllPaletteDetails);

    // Spacebar to generate
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        generatePalette();
      }
    });

    // Handle color column actions
    document.getElementById('paletteContainer').addEventListener('click', (e) => {
      const lockedIndicator = e.target.closest('.locked-indicator');
      if (lockedIndicator) {
        const column = lockedIndicator.closest('.color-column');
        const index = parseInt(column.dataset.index);
        toggleLock(index);
        return;
      }

      const actionBtn = e.target.closest('.action-btn');
      if (actionBtn) {
        const column = actionBtn.closest('.color-column');
        const index = parseInt(column.dataset.index);
        const action = actionBtn.dataset.action;

        if (action === 'lock') {
          toggleLock(index);
        } else if (action === 'copy') {
          copyHex(index);
        } else if (action === 'remove') {
          removeColor(index);
        } else if (action === 'select') {
          openColorPicker(index);
        }
      }
    });

    // Color picker events
    document.getElementById('closePicker').addEventListener('click', closeColorPicker);
    document.getElementById('colorPickerOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'colorPickerOverlay') closeColorPicker();
    });
    document.getElementById('pickerSearch').addEventListener('input', (e) => renderPickerList(e.target.value));
    document.getElementById('pickerList').addEventListener('click', (e) => {
      const item = e.target.closest('.picker-item');
      if (item) selectColorFromPicker(item.dataset.name);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeColorPicker();
    });
  });

  // Tag filtering state
  let selectedTags = new Set();

  // Preset configurations
  const PRESETS = {
    'warm-pastels': ['warm', 'light', 'muted'],
    'cool-vibrant': ['cool', 'vibrant'],
    'earth-tones': ['earth-tone'],
    'portrait': ['skin-tone'],
    'harmony': ['bright']
  };

  // Initialize tag filtering
  function initTagFiltering() {
    // Toggle tag filter section
    const toggleBtn = document.getElementById('tagFilterToggle');
    const content = document.getElementById('tagFilterContent');
    const chevron = document.getElementById('tagFilterChevron');

    if (toggleBtn && content) {
      toggleBtn.addEventListener('click', () => {
        const isHidden = content.classList.contains('hidden');
        if (isHidden) {
          content.classList.remove('hidden');
          chevron.style.transform = 'rotate(180deg)';
        } else {
          content.classList.add('hidden');
          chevron.style.transform = 'rotate(0deg)';
        }
      });
    }

    // Tag chip click handlers
    document.querySelectorAll('.tag-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        if (chip.dataset.tag === 'clear') {
          clearTagFilters();
        } else {
          toggleTag(chip.dataset.tag);
        }
      });
    });

    // Preset button handlers
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
    });

    // Clear filters button
    document.getElementById('clearTagFilters').addEventListener('click', clearTagFilters);
  }

  // Toggle a tag selection
  function toggleTag(tag) {
    if (selectedTags.has(tag)) {
      selectedTags.delete(tag);
    } else {
      selectedTags.add(tag);
    }
    updateTagUI();
    updateTagMatchCount();
  }

  // Apply a preset configuration
  function applyPreset(presetName) {
    clearTagFilters();
    const tags = PRESETS[presetName];
    if (tags) {
      tags.forEach(tag => selectedTags.add(tag));
      updateTagUI();
      updateTagMatchCount();

      // Generate a harmonious palette from filtered colors
      if (getFilteredMarkers().length >= parseInt(getSelectValue('paletteSizeSelect'))) {
        generateHarmoniousPalette();
      }
    }
  }

  // Clear all tag filters
  function clearTagFilters() {
    selectedTags.clear();
    updateTagUI();
    updateTagMatchCount();
  }

  // Update tag chip UI based on selection state
  function updateTagUI() {
    document.querySelectorAll('.tag-chip').forEach(chip => {
      const tag = chip.dataset.tag;
      if (tag === 'clear') return;

      if (selectedTags.has(tag)) {
        chip.classList.remove('bg-gray-100', 'text-gray-600');
        chip.classList.add('bg-primary-600', 'text-white');
      } else {
        chip.classList.remove('bg-primary-600', 'text-white');
        chip.classList.add('bg-gray-100', 'text-gray-600');
      }
    });

    // Update active filters display
    const activeFiltersDiv = document.getElementById('activeTagFilters');
    const activeFilterChips = document.getElementById('activeTagChips');
    const indicator = document.getElementById('tagFilterIndicator');
    const clearBtn = document.getElementById('clearTagFilters');

    if (selectedTags.size > 0) {
      activeFiltersDiv.classList.remove('hidden');
      if (indicator) indicator.classList.remove('hidden');
      if (clearBtn) clearBtn.classList.remove('hidden');
      activeFilterChips.innerHTML = Array.from(selectedTags).map(tag => `
        <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-primary-100 text-primary-700 rounded-full text-xs font-medium">
          ${tag}
          <button onclick="paletteToggleTag('${tag}')" class="hover:bg-primary-200 rounded-full p-0.5">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </span>
      `).join('');
    } else {
      activeFiltersDiv.classList.add('hidden');
      if (indicator) indicator.classList.add('hidden');
      if (clearBtn) clearBtn.classList.add('hidden');
    }
  }

  // Update the count of matching colors
  function updateTagMatchCount() {
    if (typeof markers === 'undefined' || markers.length === 0) return;

    const count = getFilteredMarkers().length;
    document.getElementById('tagMatchCount').textContent = `${count} color${count !== 1 ? 's' : ''} available`;
  }

  // Get filtered markers (line filter + tag filter)
  function getFilteredMarkers() {
    const lineFilter = getSelectValue('lineFilterSelect');
    let filtered = markers;

    if (lineFilter !== 'all') {
      filtered = filtered.filter(m => m.lines.includes(lineFilter));
    }

    if (selectedTags.size > 0) {
      const tagsArray = Array.from(selectedTags);
      filtered = filtered.filter(m =>
        m.tags && tagsArray.every(tag => m.tags.includes(tag))
      );
    }

    return filtered;
  }

  // Generate a harmonious palette from filtered colors
  function generateHarmoniousPalette() {
    const size = parseInt(getSelectValue('paletteSizeSelect'));
    const availableMarkers = getFilteredMarkers();

    if (availableMarkers.length < size) {
      showToast(`Not enough colors match (${availableMarkers.length} available)`);
      return;
    }

    // Select colors using harmony rules
    const selectedColors = selectHarmoniousColors(availableMarkers, size);

    // Update palette
    currentPalette = selectedColors;
    lockedIndices.clear();
    renderPalette();
    showToast(`Generated ${size} harmonious colors`);
  }

  // Select colors using harmony rules (similar to theme-library)
  function selectHarmoniousColors(colorPool, count) {
    if (colorPool.length <= count) return [...colorPool];

    const selected = [];
    const used = new Set();

    // Start with a random color
    const startIdx = Math.floor(Math.random() * colorPool.length);
    selected.push(colorPool[startIdx]);
    used.add(startIdx);

    // Harmony offsets
    const harmonies = [
      { offset: 0, weight: 3 },
      { offset: 30, weight: 2 },
      { offset: -30, weight: 2 },
      { offset: 180, weight: 2 },
      { offset: 150, weight: 1 },
      { offset: -150, weight: 1 },
      { offset: 120, weight: 1 },
      { offset: -120, weight: 1 },
    ];

    while (selected.length < count && used.size < colorPool.length) {
      let bestMatch = null;
      let bestScore = -1;

      for (let i = 0; i < colorPool.length; i++) {
        if (used.has(i)) continue;

        const color = colorPool[i];
        const hue = color.hsv.h;

        let score = 0;
        for (const selectedColor of selected) {
          const selectedHue = selectedColor.hsv.h;

          for (const harmony of harmonies) {
            const targetHue = (selectedHue + harmony.offset + 360) % 360;
            const diffToHarmony = Math.min(Math.abs(hue - targetHue), 360 - Math.abs(hue - targetHue));
            if (diffToHarmony < 30) {
              score += harmony.weight * (1 - diffToHarmony / 30);
            }
          }

          const vDiff = Math.abs(color.hsv.v - selectedColor.hsv.v) / 100;
          const sDiff = Math.abs(color.hsv.s - selectedColor.hsv.s) / 100;
          score += (vDiff + sDiff) * 0.5;
        }

        if (score > bestScore) {
          bestScore = score;
          bestMatch = { color, index: i };
        }
      }

      if (bestMatch) {
        selected.push(bestMatch.color);
        used.add(bestMatch.index);
      } else {
        break;
      }
    }

    while (selected.length < count && used.size < colorPool.length) {
      const idx = Math.floor(Math.random() * colorPool.length);
      if (!used.has(idx)) {
        selected.push(colorPool[idx]);
        used.add(idx);
      }
    }

    return selected;
  }

  // Expose toggle function globally for active filter chips
  window.paletteToggleTag = function(tag) {
    toggleTag(tag);
  };

  // Load colors from URL parameter
  function loadColorsFromUrl(colorsParam) {
    const hexColors = colorsParam.split(',').map(h => decodeURIComponent(h.trim()));

    // Find matching markers for each hex color
    const matchedMarkers = hexColors.map(hex => {
      // Try exact match first
      let marker = markers.find(m => m.hex.toLowerCase() === hex.toLowerCase());
      if (marker) return marker;

      // Fall back to closest color match
      return findClosestMarker(hex);
    }).filter(Boolean);

    if (matchedMarkers.length > 0) {
      currentPalette = matchedMarkers;
      lockedIndices.clear();
      setSelectValue('paletteSizeSelect', String(currentPalette.length));
      renderPalette();
      showToast(`Loaded ${currentPalette.length} colors`);
    } else {
      generatePalette();
    }
  }

  // Find closest marker by hex color
  function findClosestMarker(targetHex) {
    if (markers.length === 0) return null;

    const target = hexToRgb(targetHex);
    if (!target) return markers[0];

    let closest = markers[0];
    let minDistance = Infinity;

    for (const marker of markers) {
      const color = hexToRgb(marker.hex);
      if (!color) continue;

      const distance = Math.sqrt(
        Math.pow(target.r - color.r, 2) +
        Math.pow(target.g - color.g, 2) +
        Math.pow(target.b - color.b, 2)
      );

      if (distance < minDistance) {
        minDistance = distance;
        closest = marker;
      }
    }

    return closest;
  }

  // Convert hex to RGB
  function hexToRgb(hex) {
    hex = hex.replace(/^#/, '');
    if (hex.length === 3) {
      hex = hex.split('').map(c => c + c).join('');
    }
    if (hex.length !== 6) return null;

    const r = parseInt(hex.slice(0, 2), 16);
    const g = parseInt(hex.slice(2, 4), 16);
    const b = parseInt(hex.slice(4, 6), 16);

    if (isNaN(r) || isNaN(g) || isNaN(b)) return null;

    return { r, g, b };
  }

  // Generate random palette
  function generatePalette() {
    const size = parseInt(getSelectValue('paletteSizeSelect'));
    const availableMarkers = getFilteredMarkers();

    if (availableMarkers.length < size) {
      showToast(`Not enough markers match (${availableMarkers.length} available)`);
      return;
    }

    const newPalette = new Array(size);
    const keptLocked = new Set();

    for (const idx of lockedIndices) {
      if (idx < size && currentPalette[idx]) {
        newPalette[idx] = currentPalette[idx];
        keptLocked.add(idx);
      }
    }
    lockedIndices = keptLocked;

    const usedNames = new Set(newPalette.filter(m => m).map(m => m.name));
    const unusedMarkers = availableMarkers.filter(m => !usedNames.has(m.name));

    for (let i = 0; i < size; i++) {
      if (!newPalette[i]) {
        if (unusedMarkers.length === 0) break;
        const randomIdx = Math.floor(Math.random() * unusedMarkers.length);
        newPalette[i] = unusedMarkers.splice(randomIdx, 1)[0];
      }
    }

    currentPalette = newPalette.filter(m => m);
    renderPalette();
  }

  // Render palette
  function renderPalette() {
    const container = document.getElementById('paletteContainer');

    container.innerHTML = currentPalette.map((marker, index) => {
      const brightness = calculateBrightness(marker.hex);
      const textColor = brightness > 128 ? '#000' : '#fff';
      const isLocked = lockedIndices.has(index);
      const lineText = marker.lines.join(' / ') || 'New only';

      const lockedIndicator = isLocked ? `
        <div class="locked-indicator" data-action="unlock" title="Click to unlock">
          <svg class="icon-locked w-5 h-5 md:w-7 md:h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <svg class="icon-unlocked w-5 h-5 md:w-7 md:h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
          </svg>
        </div>` : '';

      return `
        <div class="color-column flex-1 md:flex-[1] ${isLocked ? 'locked' : ''}"
             style="background: ${marker.hex}; color: ${textColor};"
             data-index="${index}">
          <div class="flex items-center gap-3 md:block md:text-center md:relative md:pt-0">
            ${lockedIndicator}
            <div class="flex-1 md:block">
              <div class="font-bold text-base md:text-xl md:mb-1">${marker.name}</div>
              <div class="font-bold font-mono text-lg md:text-2xl md:mb-1">${marker.code}</div>
              <div class="hidden md:block text-sm opacity-80 font-mono">${marker.hex}</div>
              <div class="hidden md:block text-xs opacity-70 mt-1">${lineText}</div>
            </div>
          </div>
          <div class="color-actions">
            <button class="action-btn" data-action="select" title="Select Color">
              <svg class="w-4 h-4 md:w-[18px] md:h-[18px]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
            </button>
            <button class="action-btn ${isLocked ? 'locked' : ''}" data-action="lock" title="${isLocked ? 'Unlock' : 'Lock'}">
              <svg class="w-4 h-4 md:w-[18px] md:h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${isLocked
                  ? '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>'
                  : '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'
                }
              </svg>
            </button>
            <button class="action-btn" data-action="copy" title="Copy Hex">
              <svg class="w-4 h-4 md:w-[18px] md:h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
            </button>
            <button class="action-btn" data-action="remove" title="Remove">
              <svg class="w-4 h-4 md:w-[18px] md:h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  // Toggle lock
  function toggleLock(index) {
    if (lockedIndices.has(index)) {
      lockedIndices.delete(index);
    } else {
      lockedIndices.add(index);
    }
    renderPalette();
  }

  // Copy hex to clipboard
  async function copyHex(index) {
    const marker = currentPalette[index];
    if (marker) {
      try {
        await navigator.clipboard.writeText(marker.hex);
        showToast(`Copied ${marker.hex}`);
      } catch (err) {
        showToast('Failed to copy');
      }
    }
  }

  // Copy all palette details to clipboard
  async function copyAllPaletteDetails() {
    if (currentPalette.length === 0) {
      showToast('No colors to copy');
      return;
    }

    const lines = currentPalette.map((marker, index) => {
      const lineText = marker.lines.join(' / ') || 'New only';
      return `${index + 1}. ${marker.name} - ${marker.code} (${marker.hex}) [${lineText}]`;
    });

    const textToCopy = lines.join('\n');

    try {
      await navigator.clipboard.writeText(textToCopy);
      showToast(`Copied ${currentPalette.length} colors`);
    } catch (err) {
      showToast('Failed to copy');
    }
  }

  // Remove color from palette
  function removeColor(index) {
    if (currentPalette.length <= 2) {
      showToast('Minimum 2 colors required');
      return;
    }

    currentPalette.splice(index, 1);
    lockedIndices.delete(index);

    const newLocked = new Set();
    for (const idx of lockedIndices) {
      if (idx > index) {
        newLocked.add(idx - 1);
      } else {
        newLocked.add(idx);
      }
    }
    lockedIndices = newLocked;

    setSelectValue('paletteSizeSelect', String(currentPalette.length));
    renderPalette();
  }

  // Show toast notification
  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('visible');

    setTimeout(() => {
      toast.classList.remove('visible');
    }, 2000);
  }

  // Color picker state
  let pickerTargetIndex = 0;

  function openColorPicker(index) {
    pickerTargetIndex = index;
    const overlay = document.getElementById('colorPickerOverlay');
    const searchInput = document.getElementById('pickerSearch');

    overlay.classList.add('visible');
    searchInput.value = '';
    searchInput.focus();
    renderPickerList('');
  }

  function closeColorPicker() {
    document.getElementById('colorPickerOverlay').classList.remove('visible');
  }

  function renderPickerList(query) {
    const list = document.getElementById('pickerList');
    // Get markers filtered by line and tags
    const lineFilter = getSelectValue('lineFilterSelect');
    let availableMarkers = markers;
    if (lineFilter !== 'all') {
      availableMarkers = availableMarkers.filter(m => m.lines.includes(lineFilter));
    }
    // Don't apply tag filters to picker to give full flexibility
    const usedNames = new Set(currentPalette.map(m => m.name));

    let filtered = availableMarkers;
    if (query.trim()) {
      const q = query.toLowerCase();
      filtered = availableMarkers.filter(m =>
        m.name.toLowerCase().includes(q) ||
        m.code.toLowerCase().includes(q)
      );
    }

    if (filtered.length === 0) {
      list.innerHTML = '<div class="p-8 text-center text-gray-500">No markers found</div>';
      return;
    }

    filtered.sort((a, b) => {
      const aUsed = usedNames.has(a.name);
      const bUsed = usedNames.has(b.name);
      if (aUsed !== bUsed) return aUsed ? 1 : -1;
      return a.name.localeCompare(b.name);
    });

    list.innerHTML = filtered.map(marker => {
      const isUsed = usedNames.has(marker.name);
      const opacity = isUsed ? '0.5' : '1';

      return `
        <div class="picker-item" data-name="${marker.name}" style="opacity: ${opacity}">
          <div class="picker-swatch" style="background: ${marker.hex};"></div>
          <div class="flex-1">
            <div class="font-semibold text-sm text-gray-800">${marker.name}</div>
            <div class="text-xs text-gray-500">${marker.code} &bull; ${marker.hex}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function selectColorFromPicker(name) {
    const marker = markers.find(m => m.name === name);
    if (marker) {
      currentPalette[pickerTargetIndex] = marker;
      renderPalette();
      closeColorPicker();
    }
  }
</script>
{% endblock %}
