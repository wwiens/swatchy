<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate random color palettes using Ohuhu marker colors.">
  <title>Ohuhu Palette Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Verdana, sans-serif;
      background: #1a1a1a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: #111;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #333;
    }

    .header h1 {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      color: #aaa;
      font-size: 12px;
    }

    .control-group select {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      font-family: Verdana, sans-serif;
      font-size: 12px;
      cursor: pointer;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: Verdana, sans-serif;
      font-size: 13px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #4a9eff;
      color: #fff;
    }

    .btn-primary:hover {
      background: #3a8eef;
    }

    .spacebar-hint {
      color: #666;
      font-size: 11px;
    }

    .spacebar-hint kbd {
      background: #333;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #444;
      color: #aaa;
    }

    /* Palette display */
    .palette-container {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .color-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      cursor: pointer;
      transition: flex 0.3s;
      min-width: 0;
    }

    .color-column:hover .color-actions {
      opacity: 1;
    }

    .locked-indicator {
      width: 44px;
      height: 44px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .locked-indicator:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .locked-indicator svg {
      width: 28px;
      height: 28px;
      opacity: 0.7;
    }

    .locked-indicator .icon-unlocked {
      display: none;
    }

    .locked-indicator:hover .icon-locked {
      display: none;
    }

    .locked-indicator:hover .icon-unlocked {
      display: block;
    }

    .color-info {
      text-align: center;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .color-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .color-code {
      font-size: 24px;
      font-weight: bold;
      font-family: monospace;
      letter-spacing: 1px;
      margin-bottom: 5px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .color-hex {
      font-size: 14px;
      font-family: monospace;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .color-lines {
      font-size: 11px;
      opacity: 0.7;
    }

    /* Color action buttons */
    .color-actions {
      position: absolute;
      bottom: 20px;
      display: flex;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.2);
      color: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(5px);
    }

    .action-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    .action-btn.locked {
      background: rgba(255,255,255,0.4);
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Color picker modal */
    .color-picker-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
    }

    .color-picker-overlay.visible {
      display: flex;
    }

    .color-picker {
      background: #222;
      border-radius: 12px;
      width: 350px;
      max-width: 90vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .color-picker-header {
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .color-picker-header h3 {
      color: #fff;
      font-size: 16px;
      margin: 0;
    }

    .close-picker {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .close-picker:hover {
      color: #fff;
    }

    .color-picker-search {
      padding: 15px;
      border-bottom: 1px solid #333;
    }

    .color-picker-search input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #1a1a1a;
      color: #fff;
      font-family: Verdana, sans-serif;
      font-size: 14px;
    }

    .color-picker-search input::placeholder {
      color: #666;
    }

    .color-picker-search input:focus {
      outline: none;
      border-color: #4a9eff;
    }

    .color-picker-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .picker-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.15s;
    }

    .picker-item:hover {
      background: #333;
    }

    .picker-swatch {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      margin-right: 12px;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .picker-info {
      flex-grow: 1;
    }

    .picker-name {
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .picker-code {
      color: #888;
      font-size: 12px;
      font-family: monospace;
    }

    .picker-no-results {
      color: #666;
      text-align: center;
      padding: 30px;
      font-size: 14px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 800px) {
      .palette-container {
        flex-direction: column;
      }

      .color-column {
        min-height: 120px;
        padding: 15px;
      }

      .color-name {
        font-size: 14px;
      }

      .color-code {
        font-size: 18px;
      }

      .color-actions {
        opacity: 1;
        position: relative;
        bottom: auto;
        margin-top: 10px;
      }

      .action-btn {
        width: 35px;
        height: 35px;
      }
    }

    @media (max-width: 500px) {
      .header {
        padding: 10px 15px;
      }

      .header h1 {
        font-size: 14px;
      }

      .spacebar-hint {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Ohuhu Palette Generator</h1>
    <div class="header-controls">
      <div class="control-group">
        <label for="paletteSize">Colors:</label>
        <select id="paletteSize">
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5" selected>5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="control-group">
        <label for="lineFilter">Line:</label>
        <select id="lineFilter">
          <option value="all">All</option>
          <option value="Honolulu">Honolulu</option>
          <option value="Oahu">Oahu</option>
          <option value="Kaala">Kaala</option>
        </select>
      </div>
      <button class="btn btn-primary" id="generateBtn">Generate</button>
      <span class="spacebar-hint">or press <kbd>Space</kbd></span>
    </div>
  </header>

  <div class="palette-container" id="paletteContainer">
    <!-- Color columns will be rendered here -->
  </div>

  <div class="toast" id="toast">Copied!</div>

  <!-- Color picker modal -->
  <div class="color-picker-overlay" id="colorPickerOverlay">
    <div class="color-picker">
      <div class="color-picker-header">
        <h3>Select Color</h3>
        <button class="close-picker" id="closePicker">&times;</button>
      </div>
      <div class="color-picker-search">
        <input type="text" id="pickerSearch" placeholder="Search by name or code..." autocomplete="off">
      </div>
      <div class="color-picker-list" id="pickerList">
        <!-- Colors will be rendered here -->
      </div>
    </div>
  </div>

  <script>
    // State
    let colorData = {};
    let markers = [];
    let currentPalette = [];
    let lockedIndices = new Set();

    // Load color data
    async function loadColorData() {
      try {
        const response = await fetch('ColorData.json');
        colorData = await response.json();

        // Process markers
        markers = [];
        for (const [name, data] of Object.entries(colorData)) {
          if (!data.Hex || name === 'Colorless Blender') continue;

          const lines = [];
          if (data.Honolulu) lines.push('Honolulu');
          if (data.Oahu) lines.push('Oahu');
          if (data.Kaala) lines.push('Kaala');

          markers.push({
            name,
            hex: data.Hex,
            code: data.New,
            lines,
            data
          });
        }

        generatePalette();
      } catch (error) {
        console.error('Error loading color data:', error);
      }
    }

    // Calculate brightness for text color
    function calculateBrightness(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return (r * 299 + g * 587 + b * 114) / 1000;
    }

    // Get filtered markers
    function getFilteredMarkers() {
      const lineFilter = document.getElementById('lineFilter').value;
      if (lineFilter === 'all') {
        return markers;
      }
      return markers.filter(m => m.lines.includes(lineFilter));
    }

    // Generate random palette
    function generatePalette() {
      const size = parseInt(document.getElementById('paletteSize').value);
      const availableMarkers = getFilteredMarkers();

      if (availableMarkers.length < size) {
        showToast('Not enough markers available');
        return;
      }

      // Keep locked colors, regenerate others
      const newPalette = new Array(size);

      // First, place locked colors (adjusting indices if size changed)
      const keptLocked = new Set();
      for (const idx of lockedIndices) {
        if (idx < size && currentPalette[idx]) {
          newPalette[idx] = currentPalette[idx];
          keptLocked.add(idx);
        }
      }
      lockedIndices = keptLocked;

      // Get markers not already in palette
      const usedNames = new Set(newPalette.filter(m => m).map(m => m.name));
      const unusedMarkers = availableMarkers.filter(m => !usedNames.has(m.name));

      // Fill remaining slots
      for (let i = 0; i < size; i++) {
        if (!newPalette[i]) {
          if (unusedMarkers.length === 0) break;
          const randomIdx = Math.floor(Math.random() * unusedMarkers.length);
          newPalette[i] = unusedMarkers.splice(randomIdx, 1)[0];
        }
      }

      currentPalette = newPalette.filter(m => m);
      renderPalette();
    }

    // Render palette
    function renderPalette() {
      const container = document.getElementById('paletteContainer');

      container.innerHTML = currentPalette.map((marker, index) => {
        const brightness = calculateBrightness(marker.hex);
        const textColor = brightness > 128 ? '#000' : '#fff';
        const isLocked = lockedIndices.has(index);
        const lineText = marker.lines.join(' / ') || 'New only';
        const lockedIndicator = isLocked ? `
            <div class="locked-indicator" data-action="unlock" title="Click to unlock">
              <svg class="icon-locked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <svg class="icon-unlocked" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
              </svg>
            </div>` : '';
        return `
          <div class="color-column ${isLocked ? 'locked' : ''}"
               style="background: ${marker.hex}; color: ${textColor};"
               data-index="${index}">
            <div class="color-info">
              ${lockedIndicator}
              <div class="color-name">${marker.name}</div>
              <div class="color-code">${marker.code}</div>
              <div class="color-hex">${marker.hex}</div>
              <div class="color-lines">${lineText}</div>
            </div>
            <div class="color-actions">
              <button class="action-btn" data-action="select" title="Select Color">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.04 10 9c0 3.31-2.69 6-6 6h-1.77c-.28 0-.5.22-.5.5 0 .12.05.23.13.33.41.47.64 1.06.64 1.67A2.5 2.5 0 0 1 12 22zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8c.28 0 .5-.22.5-.5a.54.54 0 0 0-.14-.35c-.41-.46-.63-1.05-.63-1.65a2.5 2.5 0 0 1 2.5-2.5H16c2.21 0 4-1.79 4-4 0-3.86-3.59-7-8-7z"/><circle cx="6.5" cy="11.5" r="1.5"/><circle cx="9.5" cy="7.5" r="1.5"/><circle cx="14.5" cy="7.5" r="1.5"/><circle cx="17.5" cy="11.5" r="1.5"/>
                </svg>
              </button>
              <button class="action-btn ${isLocked ? 'locked' : ''}" data-action="lock" title="${isLocked ? 'Unlock' : 'Lock'}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  ${isLocked
                    ? '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>'
                    : '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'
                  }
                </svg>
              </button>
              <button class="action-btn" data-action="copy" title="Copy Hex">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
              </button>
              <button class="action-btn" data-action="remove" title="Remove">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle lock
    function toggleLock(index) {
      if (lockedIndices.has(index)) {
        lockedIndices.delete(index);
      } else {
        lockedIndices.add(index);
      }
      renderPalette();
    }

    // Copy hex to clipboard
    async function copyHex(index) {
      const marker = currentPalette[index];
      if (marker) {
        try {
          await navigator.clipboard.writeText(marker.hex);
          showToast(`Copied ${marker.hex}`);
        } catch (err) {
          showToast('Failed to copy');
        }
      }
    }

    // Remove color from palette
    function removeColor(index) {
      if (currentPalette.length <= 2) {
        showToast('Minimum 2 colors required');
        return;
      }

      currentPalette.splice(index, 1);
      lockedIndices.delete(index);

      // Adjust locked indices
      const newLocked = new Set();
      for (const idx of lockedIndices) {
        if (idx > index) {
          newLocked.add(idx - 1);
        } else {
          newLocked.add(idx);
        }
      }
      lockedIndices = newLocked;

      // Update palette size selector
      document.getElementById('paletteSize').value = currentPalette.length;

      renderPalette();
    }

    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');

      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2000);
    }

    // Color picker state
    let pickerTargetIndex = 0;

    // Open color picker
    function openColorPicker(index) {
      pickerTargetIndex = index;
      const overlay = document.getElementById('colorPickerOverlay');
      const searchInput = document.getElementById('pickerSearch');

      overlay.classList.add('visible');
      searchInput.value = '';
      searchInput.focus();
      renderPickerList('');
    }

    // Close color picker
    function closeColorPicker() {
      document.getElementById('colorPickerOverlay').classList.remove('visible');
    }

    // Render picker list
    function renderPickerList(query) {
      const list = document.getElementById('pickerList');
      const availableMarkers = getFilteredMarkers();
      const usedNames = new Set(currentPalette.map(m => m.name));

      // Filter markers
      let filtered = availableMarkers;
      if (query.trim()) {
        const q = query.toLowerCase();
        filtered = availableMarkers.filter(m =>
          m.name.toLowerCase().includes(q) ||
          m.code.toLowerCase().includes(q)
        );
      }

      if (filtered.length === 0) {
        list.innerHTML = '<div class="picker-no-results">No markers found</div>';
        return;
      }

      // Sort: unused first, then alphabetically
      filtered.sort((a, b) => {
        const aUsed = usedNames.has(a.name);
        const bUsed = usedNames.has(b.name);
        if (aUsed !== bUsed) return aUsed ? 1 : -1;
        return a.name.localeCompare(b.name);
      });

      list.innerHTML = filtered.map(marker => {
        const isUsed = usedNames.has(marker.name);
        const opacity = isUsed ? '0.5' : '1';

        return `
          <div class="picker-item" data-name="${marker.name}" style="opacity: ${opacity}">
            <div class="picker-swatch" style="background: ${marker.hex};"></div>
            <div class="picker-info">
              <div class="picker-name">${marker.name}</div>
              <div class="picker-code">${marker.code} &bull; ${marker.hex}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Select color from picker
    function selectColorFromPicker(name) {
      const marker = markers.find(m => m.name === name);
      if (marker) {
        currentPalette[pickerTargetIndex] = marker;
        renderPalette();
        closeColorPicker();
      }
    }

    // Event listeners
    document.getElementById('generateBtn').addEventListener('click', generatePalette);
    document.getElementById('paletteSize').addEventListener('change', generatePalette);
    document.getElementById('lineFilter').addEventListener('change', generatePalette);

    // Spacebar to generate
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
        e.preventDefault();
        generatePalette();
      }
    });

    // Handle color column actions
    document.getElementById('paletteContainer').addEventListener('click', (e) => {
      // Check for locked indicator click (unlock)
      const lockedIndicator = e.target.closest('.locked-indicator');
      if (lockedIndicator) {
        const column = lockedIndicator.closest('.color-column');
        const index = parseInt(column.dataset.index);
        toggleLock(index);
        return;
      }

      // Check for action button click
      const actionBtn = e.target.closest('.action-btn');
      if (actionBtn) {
        const column = actionBtn.closest('.color-column');
        const index = parseInt(column.dataset.index);
        const action = actionBtn.dataset.action;

        if (action === 'lock') {
          toggleLock(index);
        } else if (action === 'copy') {
          copyHex(index);
        } else if (action === 'remove') {
          removeColor(index);
        } else if (action === 'select') {
          openColorPicker(index);
        }
      }
    });

    // Color picker events
    document.getElementById('closePicker').addEventListener('click', closeColorPicker);

    document.getElementById('colorPickerOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'colorPickerOverlay') {
        closeColorPicker();
      }
    });

    document.getElementById('pickerSearch').addEventListener('input', (e) => {
      renderPickerList(e.target.value);
    });

    document.getElementById('pickerList').addEventListener('click', (e) => {
      const item = e.target.closest('.picker-item');
      if (item) {
        selectColorFromPicker(item.dataset.name);
      }
    });

    // Close picker on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeColorPicker();
      }
    });

    // Initialize
    loadColorData();
  </script>
</body>
</html>
